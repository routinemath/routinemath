<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ì‹œí—˜ ëŒ€ë¹„ ì˜¤ë‹µ í’€ì´ ìƒì„±ê¸°</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        body { margin: 0; padding: 20px; font-family: 'Malgun Gothic', sans-serif; background: #f0f0f0; }
        .control-panel { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .control-panel h2 { margin-top: 0; color: #333; }
        
        .student-section { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .student-section select, .student-section input { padding: 8px; font-size: 14px; margin-right: 10px; border: 1px solid #ddd; border-radius: 4px; }
        
        .dashboard { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .dashboard h3 { margin: 0 0 15px 0; }
        .level-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 15px 0; }
        .level-card { background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center; }
        .level-card .label { font-size: 14px; opacity: 0.9; margin-bottom: 5px; }
        .level-card .count { font-size: 32px; font-weight: bold; }
        
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .control-group input[type="text"], .control-group input[type="number"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        
        .btn { background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin: 5px; }
        .btn:hover { opacity: 0.9; }
        .btn-danger { background: #f44336; }
        .btn-export { background: #607D8B; }
        
        .status { margin-top: 10px; padding: 10px; background: #e8f5e9; border-left: 4px solid #4CAF50; display: none; }
        
        @/* í˜ì´ì§€ ì„¤ì • */
@page { 
    size: A4 portrait; 
    margin: 6mm; 
}

#quizSheet { 
    background: white; 
    max-width: 210mm; 
    margin: 20px auto; 
    box-shadow: 0 0 10px rgba(0,0,0,0.1); 
}

/* ì²« í˜ì´ì§€ */
/* Ã¬Â²Â« Ã­Å½ËœÃ¬Â´Ã¬Â§â‚¬ */
.first-page {
    min-height: 297mm;
    padding: 3mm;
    page-break-after: always;
}

.exam-header {
    text-align: center;
    margin-bottom: 3mm;
    padding: 2mm 0;
}

.exam-title {
    font-size: 18pt;
    font-weight: bold;
    margin: 0;
}

/* Ã¬Â¼Ã«Â°Ëœ Ã­Å½ËœÃ¬Â´Ã¬Â§â‚¬ */
.exam-page {
    min-height: 297mm;
    padding: 3mm;
    page-break-after: always;
    position: relative;
}

.exam-page:last-child {
    page-break-after: auto;
}

/* 2x2 ÃªÂ·Â¸Ã«Â¦Â¬Ã«"Å“ Ã­â€¦Å’Ã¬Â´Ã«Â¸" */
.problem-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: repeat(2, 1fr);
    gap: 3mm;
    height: 280mm;
    width: 100%;
}

.first-page .problem-grid {
    height: 260mm;
}

/* Ã«Â¬Â¸Ã¬ Å“ Ã¬â€¦â‚¬ */
.problem-cell {
    border: 1px solid #333;
    border-left: none;
    border-right: none;
    display: flex;
    flex-direction: column;
    position: relative;
    background: white;
    overflow: hidden;
}
/* Ã«Â¬Â¸Ã¬ Å“ Ã­â€”Â¤Ã«" (Ã«Â²Ë†Ã­ËœÂ¸ + Ã­Å’Å’Ã¬Â¼Ã«Âªâ€¦) */
.problem-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 2mm;
    border-bottom: 1px solid #ddd;
    background: #f9f9f9;
    min-height: 8mm;
}

.problem-header .number {
    font-weight: bold;
    font-size: 11pt;
}

.problem-header .filename {
    font-size: 8pt;
    color: #666;
    max-width: 60%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Ã¬Â´Ã«Â¯Â¸Ã¬Â§â‚¬ Ã¬ËœÃ¬â€”Â­ */
.image-container {
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding: 2mm;
    max-height: 50mm;
    overflow: hidden;
}

.problem-image {
    max-width: 100%;
    max-height: 48mm;
    object-fit: contain;
}

/* Ã­'â‚¬Ã¬Â´ ÃªÂ³ÂµÃªÂ°â€ */
.solution-area {
    flex: 1;
    padding: 2mm;
    display: flex;
    flex-direction: column;
}

.solution-label {
    font-size: 9pt;
    color: #999;
    margin-bottom: 2mm;
    font-weight: bold;
}

/* Ã¬ â€¢Ã«â€¹ÂµÃ¬Â²Â´Ã­Â¬ Ã«Â²â€Ã­Å Â¼ */
.answer-check {
    position: absolute;
    top: 2mm;
    right: 2mm;
    display: flex;
    gap: 2px;
    z-index: 21;
}

.check-btn {
    padding: 2px 6px;
    font-size: 9px;
    border: 1px solid #ccc;
    border-radius: 3px;
    cursor: pointer;
    background: white;
}

/* Ã¬Â¸Ã¬â€¡â€ Ã¬â€¹Å“ */
@media print {
    #quizSheet { 
        margin: 0; 
        box-shadow: none; 
    }
    .answer-check { 
        display: none !important; 
    }
    .exam-page, .first-page {
        min-height: auto;
        padding: 3mm;
    }
    .exam-header {
        padding: 2mm 0;
        margin-bottom: 3mm;
    }
    .exam-title {
        font-size: 16pt;
    }
    .problem-grid {
        gap: 2mm;
    }
}

/* ë ˆë²¨ ë±ƒì§€ - ë¬¸ì œë²ˆí˜¸ ì˜†ì— ì‘ê²Œ */
.level-badge {
    display: inline-block;
    margin-left: 5px;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 9pt;
    font-weight: normal;
}

/* ì •ë‹µì²´í¬ ë²„íŠ¼ - ë¬¸ì œ ìš°ì¸¡ ìƒë‹¨ */
.answer-check {
    position: absolute;
    top: 6px;
    right: 6px;
    display: flex;
    gap: 3px;
    z-index: 21;
}

.check-btn {
    padding: 3px 8px;
    font-size: 10px;
    border: 1px solid #ccc;
    border-radius: 3px;
    cursor: pointer;
    background: white;
}

/* ì¸ì‡„ ì‹œ */
@media print {
    #quizSheet { 
        margin: 0; 
        box-shadow: none; 
    }
    .answer-check, .level-badge { 
        display: none !important; 
    }
    .exam-page, .first-page {
        min-height: auto;
        padding: 4mm;
    }
    .exam-header {
        padding-top: 1mm;
        margin-bottom: 4mm;
        padding-bottom: 2mm;
    }
    .exam-title {
        font-size: 18pt;
    }
    .two-column {
        gap: 3mm;
    }   
}
       .check-btn:hover { opacity: 0.8; }
        .check-btn.correct { background: #4CAF50; color: white; border-color: #4CAF50; }
        .check-btn.wrong { background: #f44336; color: white; border-color: #f44336; }
        
        @media print {
            body { background: white; }
            .control-panel, .dashboard, .student-section { display: none !important; }
            .answer-check { display: none !important; }
        }
.problem-item { 
    display: flex; 
    align-items: center; 
    padding: 8px; 
    border-bottom: 1px solid #ddd; 
}
.problem-item:hover { background: #f5f5f5; }
.problem-item .name { flex: 1; }
    </style>
</head>
<body>
    <div class="control-panel">
        <h2>ğŸ¯ ì‹œí—˜ ëŒ€ë¹„ ì˜¤ë‹µ í’€ì´ ìƒì„±ê¸°</h2>
        
        <div class="student-section">
            <strong>ğŸ‘¤ í•™ìƒ:</strong>
            <select id="studentSelect" onchange="switchStudent()">
                <option value="">í•™ìƒ ì„ íƒ</option>
            </select>
            <input type="text" id="newStudentName" placeholder="ìƒˆ í•™ìƒ ì´ë¦„" style="width: 150px;">
            <button class="btn" onclick="addStudent()">â• ì¶”ê°€</button>
            <button class="btn btn-danger" onclick="deleteStudent()">ğŸ—‘ï¸ ì‚­ì œ</button>
        </div>
        
        <div class="dashboard" id="dashboard" style="display:none;">
            <h3>ğŸ“Š <span id="currentStudentName"></span>ë‹˜ì˜ í•™ìŠµ í˜„í™©</h3>
            <div class="level-stats">
                <div class="level-card">
                    <div class="label">âŒ ì·¨ì•½ë¬¸ì œ</div>
                    <div class="count" id="weakCount">0</div>
                </div>
                <div class="level-card">
                    <div class="label">ğŸ”¶ ë³µìŠµí•„ìš”</div>
                    <div class="count" id="reviewCount">0</div>
                </div>
                <div class="level-card">
                    <div class="label">âœ… ì™„ì „ì •ë³µ</div>
                    <div class="count" id="masterCount">0</div>
                </div>
            </div>
        </div>
        
        <div class="control-group">
            <label>ğŸ“ ì´ë¯¸ì§€ í´ë” ì„ íƒ (PNG íŒŒì¼):</label>
            <input type="file" id="folderInput" webkitdirectory directory multiple accept="image/png">
        </div>
        
        <div class="control-group">
            <label>ğŸ” íŒŒì¼ëª… í•„í„° (ì„ íƒì‚¬í•­):</label>
            <input type="text" id="filterInput" placeholder="ì˜ˆ: ì¤‘2, ì¼ì°¨ë°©ì •ì‹" style="width: 300px;">
        </div>
        
<div class="control-group" style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0;">
    <h3 style="margin-top: 0;">ğŸ“¸ ë¬¸ì œ ì´¬ì˜í•˜ê¸°</h3>
    <div>
        <button class="btn" onclick="startCamera()">ğŸ“· ì¹´ë©”ë¼ ì—´ê¸°</button>
        <button class="btn btn-export" onclick="document.getElementById('photoInput').click()">ğŸ–¼ï¸ ê°¤ëŸ¬ë¦¬ì—ì„œ ì„ íƒ</button>
        <input type="file" id="photoInput" accept="image/*" style="display:none;" onchange="handlePhotoSelect(event)">
    </div>
    
    <div id="cameraContainer" style="display:none; margin-top:15px;">
        <video id="cameraVideo" autoplay playsinline style="width:100%; max-width:500px; border:2px solid #333; border-radius:8px;"></video>
        <div style="margin-top:10px;">
            <button class="btn" onclick="capturePhoto()">ğŸ“¸ ì´¬ì˜</button>
            <button class="btn btn-danger" onclick="stopCamera()">âŒ ì·¨ì†Œ</button>
        </div>
    </div>
    
    <canvas id="photoCanvas" style="display:none;"></canvas>
    
    <div id="capturedPhotoContainer" style="display:none; margin-top:15px;">
        <img id="capturedPhoto" style="max-width:100%; border:2px solid #4CAF50; border-radius:8px;">
        <div style="margin-top:10px;">
            <input type="text" id="photoFilename" placeholder="íŒŒì¼ëª… ì…ë ¥ (ì˜ˆ: ì¤‘2_ì¼ì°¨ë°©ì •ì‹_01)" style="width:300px; padding:8px; margin-right:10px;">
            <button class="btn" onclick="savePhoto()">ğŸ’¾ ì €ì¥</button>
            <button class="btn btn-danger" onclick="cancelPhoto()">âŒ ì·¨ì†Œ</button>
        </div>
    </div>
</div>



        <div class="control-group">
            <label>ğŸ² ì¶œì œ ë°©ì‹:</label>
            <label><input type="radio" name="sortMode" value="random" checked> ëœë¤ ì¶œì œ</label>
            <label><input type="radio" name="sortMode" value="sorted"> íŒŒì¼ëª… ìˆœì„œëŒ€ë¡œ</label>
        </div>
        <div class="control-group">
    <label><input type="checkbox" id="showFilename"> ğŸ“ ì´ë¯¸ì§€ íŒŒì¼ëª… í‘œì‹œ</label>
</div>

        <div class="control-group">
            <label><input type="checkbox" id="weakOnly"> âŒ ì·¨ì•½ë¬¸ì œë§Œ ì¶œì œ</label>
            <label><input type="checkbox" id="includeReview" checked> ğŸ”¶ ë³µìŠµí•„ìš” í¬í•¨</label>
            <label><input type="checkbox" id="includeMaster"> âœ… ì™„ì „ì •ë³µ í¬í•¨ (ì‹¤ë ¥ ìœ ì§€ìš©)</label>
        </div>
        
        <div class="control-group">
            <label>ğŸ“ ì‹œí—˜ì§€ ì œëª©: <input type="text" id="examTitle" value="ì˜¤ë‹µ í•™ìŠµ ë¬¸ì œì§€" style="width:300px;"></label>
	<label>ğŸ“„ í˜ì´ì§€ë‹¹ ë¬¸ì œ ìˆ˜: <input type="number" id="quizPerPage" value="6" min="1" max="12" style="width:60px;"></label>
            <label>ğŸ“š ì´ í˜ì´ì§€ ìˆ˜: <input type="number" id="totalPages" value="6" min="1" max="20" style="width:60px;"></label>
        </div>
        
        <div>
            <button class="btn" onclick="generateQuiz()">ğŸ² ì‹œí—˜ì§€ ìƒì„±</button>
            <button class="btn" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„ / PDF ì €ì¥</button>
            <button class="btn btn-export" onclick="exportData()">ğŸ“¤ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
            <button class="btn btn-export" onclick="document.getElementById('importFile').click()">ğŸ“¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</button>
            <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importData(event)">
            <button class="btn btn-danger" onclick="resetAllData()">ğŸ—‘ï¸ ì „ì²´ ì´ˆê¸°í™”</button>
        </div>
        
        <div id="status" class="status"></div>
<div id="problemList" style="background:white; padding:15px; border-radius:8px; margin-top:20px; display:none;">
    <h3>ğŸ“‹ ë¬¸ì œ ëª©ë¡</h3>
    <div id="listContent"></div>
</div>
    </div>
    
    <div id="quizSheet"></div>
    
    <script>
        let allImages = [];
        let currentStudent = '';
        let currentQuizImages = [];
        
        // ì´ˆê¸°í™”
       // ì´ˆê¸°í™”
        async function init() {
            await initDB(); // IndexedDB ì´ˆê¸°í™”
            loadStudents();
            const saved = localStorage.getItem('currentStudent');
            if (saved) {
                currentStudent = saved;
                document.getElementById('studentSelect').value = saved;
                switchStudent();
                loadPhotosFromDB(); // ì´¬ì˜í•œ ì‚¬ì§„ ë¶ˆëŸ¬ì˜¤ê¸°
            }
        }
        
        // í•™ìƒ ëª©ë¡ ë¡œë“œ
        function loadStudents() {
            const students = JSON.parse(localStorage.getItem('students') || '[]');
            const select = document.getElementById('studentSelect');
            select.innerHTML = '<option value="">í•™ìƒ ì„ íƒ</option>';
            students.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                select.appendChild(opt);
            });
        }
        
        // í•™ìƒ ì¶”ê°€
        function addStudent() {
            const name = document.getElementById('newStudentName').value.trim();
            if (!name) {
                showStatus('í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.', false);
                return;
            }
            
            const students = JSON.parse(localStorage.getItem('students') || '[]');
            if (students.includes(name)) {
                showStatus('ì´ë¯¸ ë“±ë¡ëœ í•™ìƒì…ë‹ˆë‹¤.', false);
                return;
            }
            
            students.push(name);
            localStorage.setItem('students', JSON.stringify(students));
            localStorage.setItem(`student_${name}`, JSON.stringify({}));
            
            loadStudents();
            document.getElementById('studentSelect').value = name;
            document.getElementById('newStudentName').value = '';
            currentStudent = name;
            localStorage.setItem('currentStudent', name);
            switchStudent();
            showStatus(`${name} í•™ìƒì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, true);
        }
        
        // í•™ìƒ ì‚­ì œ
        function deleteStudent() {
            if (!currentStudent) {
                showStatus('ì‚­ì œí•  í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”.', false);
                return;
            }
            
            if (!confirm(`${currentStudent} í•™ìƒì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            const students = JSON.parse(localStorage.getItem('students') || '[]');
            const newStudents = students.filter(s => s !== currentStudent);
            localStorage.setItem('students', JSON.stringify(newStudents));
            localStorage.removeItem(`student_${currentStudent}`);
            
            currentStudent = '';
            localStorage.removeItem('currentStudent');
            loadStudents();
            document.getElementById('dashboard').style.display = 'none';
            showStatus('í•™ìƒì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', true);
        }
        
       function switchStudent() {
            currentStudent = document.getElementById('studentSelect').value;
            if (currentStudent) {
                localStorage.setItem('currentStudent', currentStudent);
                document.getElementById('dashboard').style.display = 'block';
                document.getElementById('currentStudentName').textContent = currentStudent;
                updateDashboard();
                loadPhotosFromDB(); // ì—¬ê¸° ì¶”ê°€!
            } else {
                document.getElementById('dashboard').style.display = 'none';
            }
        }
        
        // ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
        function updateDashboard() {
            if (!currentStudent) return;
            
            const data = JSON.parse(localStorage.getItem(`student_${currentStudent}`) || '{}');
            let weak = 0, review = 0, master = 0;
            
            Object.values(data).forEach(problem => {
                if (problem.level === 'ì·¨ì•½ë¬¸ì œ') weak++;
                else if (problem.level === 'ë³µìŠµí•„ìš”') review++;
                else if (problem.level === 'ì™„ì „ì •ë³µ') master++;
            });
            
            document.getElementById('weakCount').textContent = weak;
            document.getElementById('reviewCount').textContent = review;
            document.getElementById('masterCount').textContent = master;
        }
        
        // ì´ë¯¸ì§€ ë¡œë“œ
        document.getElementById('folderInput').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            allImages = files.filter(f => f.name.toLowerCase().endsWith('.png'));
            showStatus(`âœ… ${allImages.length}ê°œì˜ PNG ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`, true);
            showProblemList();
        });

        function showProblemList() {
            if (!currentStudent || allImages.length === 0) return;
            
            const data = JSON.parse(localStorage.getItem(`student_${currentStudent}`) || '{}');
            let html = '';
            
            allImages.forEach(img => {
                const level = data[img.name]?.level || 'ì·¨ì•½ë¬¸ì œ';
                html += `
                    <div class="problem-item">
                        <span class="name">${img.name}</span>
                        <span style="margin:0 10px; color:#999;">${level}</span>
                        <button class="btn" style="padding:5px 10px; margin:2px;" onclick="markAnswer('${img.name.replace(/'/g, "\\'")}', true)">âœ…</button>
                        <button class="btn btn-danger" style="padding:5px 10px; margin:2px;" onclick="markAnswer('${img.name.replace(/'/g, "\\'")}', false)">âŒ</button>
                    </div>
                `;
            });
            
            document.getElementById('listContent').innerHTML = html;
            document.getElementById('problemList').style.display = 'block';
        }
        
        // ì •ë‹µ/ì˜¤ë‹µ ë§ˆí‚¹
        function markAnswer(filename, isCorrect) {
            if (!currentStudent) {
                showStatus('ë¨¼ì € í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”.', false);
                return;
            }
            
            const key = `student_${currentStudent}`;
            let data = JSON.parse(localStorage.getItem(key) || '{}');
            
            if (!data[filename]) {
                data[filename] = {
                    level: 'ì·¨ì•½ë¬¸ì œ',
                    correctStreak: 0,
                    totalCorrect: 0,
                    totalWrong: 0,
                    history: []
                };
            }
            
            if (isCorrect) {
                data[filename].correctStreak++;
                data[filename].totalCorrect++;
                
                if (data[filename].correctStreak >= 3) {
                    data[filename].level = 'ì™„ì „ì •ë³µ';
                } else if (data[filename].correctStreak >= 1) {
                    data[filename].level = 'ë³µìŠµí•„ìš”';
                }
            } else {
                data[filename].correctStreak = 0;
                data[filename].totalWrong++;
                data[filename].level = 'ì·¨ì•½ë¬¸ì œ';
            }
            
            data[filename].history.push({
                date: new Date().toLocaleDateString('ko-KR'),
                result: isCorrect ? 'correct' : 'wrong'
            });
            
            localStorage.setItem(key, JSON.stringify(data));
            updateAnswerButtons();
            updateDashboard();
            showProblemList();
        }
        
        // ë‹µì•ˆ ë²„íŠ¼ ì—…ë°ì´íŠ¸
        function updateAnswerButtons() {
            if (!currentStudent) return;
            
            const data = JSON.parse(localStorage.getItem(`student_${currentStudent}`) || '{}');
            document.querySelectorAll('.quiz-box').forEach((box, idx) => {
                if (!currentQuizImages[idx]) return;
                
                const filename = currentQuizImages[idx].name;
                const problem = data[filename];
                const badge = box.querySelector('.level-badge');
                
                if (problem && badge) {
                    badge.textContent = problem.level;
                    badge.className = 'level-badge ' + 
                        (problem.level === 'ì·¨ì•½ë¬¸ì œ' ? 'weak' : 
                         problem.level === 'ë³µìŠµí•„ìš”' ? 'review' : 'master');
                }
            });
        }
        
        // --- í•µì‹¬: ì‹œí—˜ì§€ ìƒì„± (ë¬¸ì œ ë²ˆí˜¸ ë¶™ì´ê³ , í•´ì„¤ í˜ì´ì§€ë¥¼ ë’¤ì— ë¶™ì„) ---
    
function getSolutionHeight(img) {
    const ratio = img.naturalHeight / img.naturalWidth;

    if (ratio > 1.3) return '60mm';     // ì„œìˆ í˜•
    if (ratio > 0.9) return '40mm';     // ì¼ë°˜ í’€ì´
    return '25mm';                      // ê°ê´€ì‹
}

function findExplanationForByIndex(index, allImages, problemImgName) {
    const base = problemImgName.replace(/\.png$/i, '');
    return allImages.find(f =>
        f.name.includes('í•´ì„¤') && f.name.includes(base)
    ) || null;
}

function generateQuiz() {
    if (!currentStudent) {
        showStatus('ë¨¼ì € í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”.', false);
        return;
    }
    if (allImages.length === 0) {
        showStatus('ë¨¼ì € ì´ë¯¸ì§€ í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”.', false);
        return;
    }

    const filter = document.getElementById('filterInput').value.trim();
    const sortMode = document.querySelector('input[name="sortMode"]:checked').value;
    const weakOnly = document.getElementById('weakOnly').checked;
    const includeReview = document.getElementById('includeReview').checked;
    const includeMaster = document.getElementById('includeMaster').checked;
    const quizPerPage = parseInt(document.getElementById('quizPerPage').value);
    const totalPages = parseInt(document.getElementById('totalPages').value);
    const totalQuizCount = quizPerPage * totalPages;

    // í•„í„°ë§: ë¨¼ì € ê¸°ë³¸ filteredImages ì„¤ì •
    let filteredImages = allImages.slice();

    if (filter) {
        filteredImages = filteredImages.filter(img => img.name.includes(filter));
        if (filteredImages.length === 0) {
            showStatus(`í•„í„° "${filter}"ì— í•´ë‹¹í•˜ëŠ” ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.`, false);
            return;
        }
    }

    // ë ˆë²¨ í•„í„° ì ìš© (í•™ìƒ ê¸°ë¡ ê¸°ë°˜)
    const data = JSON.parse(localStorage.getItem(`student_${currentStudent}`) || '{}');
    if (weakOnly || includeReview || includeMaster) {
        let allowed = [];
        if (weakOnly) allowed = ['ì·¨ì•½ë¬¸ì œ'];
        else {
            if (!includeReview && !includeMaster) allowed = ['ì·¨ì•½ë¬¸ì œ'];
            if (includeReview) allowed.push('ë³µìŠµí•„ìš”');
            if (includeMaster) allowed.push('ì™„ì „ì •ë³µ');
            if (!allowed.includes('ì·¨ì•½ë¬¸ì œ')) allowed.push('ì·¨ì•½ë¬¸ì œ');
        }
        filteredImages = filteredImages.filter(img => {
            const level = data[img.name]?.level || 'ì·¨ì•½ë¬¸ì œ';
            return allowed.includes(level);
        });
    }

    // ë¬¸ì œìš© ì´ë¯¸ì§€ëŠ” 'í•´ì„¤'ì´ë¦„ì„ ê°€ì§„ íŒŒì¼ ì œì™¸
    filteredImages = filteredImages.filter(img => !img.name.toLowerCase().includes('í•´ì„¤'));

    if (filteredImages.length === 0) {
        showStatus('ì¡°ê±´ì— ë§ëŠ” ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. (í•´ì„¤ ì´ë¯¸ì§€ëŠ” ë¬¸ì œë¡œ í¬í•¨ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)', false);
        return;
    }

    const actualQuizCount = Math.min(totalQuizCount, filteredImages.length);
    if (actualQuizCount < totalQuizCount) {
        showStatus(`âš ï¸ ${filteredImages.length}ê°œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. (ìš”ì²­: ${totalQuizCount}ê°œ)`, true);
    }

    // ì„ íƒ ì´ë¯¸ì§€ ê²°ì • (ì •ë ¬/ëœë¤)
    let selectedImages;
    if (sortMode === 'sorted') {
        selectedImages = filteredImages.sort((a,b)=> a.name.localeCompare(b.name)).slice(0, actualQuizCount);
    } else {
        selectedImages = filteredImages.sort(()=> Math.random()-0.5).slice(0, actualQuizCount);
    }

    currentQuizImages = selectedImages; // ì „ì—­ì— ë³´ê´€

    const today = new Date().toLocaleDateString('ko-KR', { year:'numeric', month:'long', day:'numeric' });
    const examTitle = document.getElementById('examTitle').value || 'ì˜¤ë‹µ í•™ìŠµ ë¬¸ì œì§€';

    // helper: í•´ì„¤ ì°¾ê¸° (ë¬¸ì œ íŒŒì¼ëª… ê¸°ë°˜)
    function findExplanationFor(originalName) {
        const base = originalName.replace(/\.png$/i,'').toLowerCase();
        // ìš°ì„  ë™ì¼íŒŒì¼ëª… í¬í•¨ + 'í•´ì„¤' í¬í•¨
        let cand = allImages.find(f => f.name.toLowerCase().includes('í•´ì„¤') && f.name.toLowerCase().includes(base));
        if (cand) return cand;
        // ë¶€ë¶„í‚¤ì›Œë“œ ë§¤ì¹­ (ì–¸ë”ìŠ¤ì½”ì–´/ëŒ€ì‹œ/ìŠ¤í˜ì´ìŠ¤ë¡œ ë¶„ë¦¬í•œ í† í°ë“¤ë¡œ ì‹œë„)
        const parts = base.split(/[_\- ]+/).filter(Boolean);
        for (let p of parts) {
            cand = allImages.find(f => f.name.toLowerCase().includes('í•´ì„¤') && f.name.toLowerCase().includes(p));
            if (cand) return cand;
        }
        return null;
    }

    // í™”ë©´ ê·¸ë¦¬ê¸° ì‹œì‘
    // Ã­â„¢"Ã«Â©Â´ ÃªÂ·Â¸Ã«Â¦Â¬ÃªÂ¸Â° Ã¬â€¹Å“Ã¬Å¾'
    let html = '';
    let problemNumber = 1;
    const showFilename = document.getElementById('showFilename').checked;

    // ÃªÂ° Ã­Å½ËœÃ¬Â´Ã¬Â§â‚¬Ã¬Æ’Ã¬â€Â± (2x2 ÃªÂ·Â¸Ã«Â¦Â¬Ã«"Å“)
    for (let page = 0; page < totalPages; page++) {
        const start = page * quizPerPage;
        const end = start + quizPerPage;
        const pageImages = selectedImages.slice(start, end);
        if (pageImages.length === 0) break;

        // Ã¬Â²Â«Ã­Å½ËœÃ¬Â´Ã¬Â§â‚¬Ã¬â€” Ã¬ Å“Ã«ÂªÂ© Ã¬Â¶"ÃªÂ°â‚¬
        if (page === 0) {
            html += `
            <div class="first-page">
                <div class="exam-header">
                    <div class="exam-title">${examTitle}</div>
                </div>
                <div class="problem-grid">
            `;
        } else {
            html += `<div class="exam-page"><div class="problem-grid">`;
        }

        // 2x2 ÃªÂ·Â¸Ã«Â¦Â¬Ã«"Å“Ã¬â€” Ã«Â¬Â¸Ã¬ Å“ Ã«Â°Â°Ã¬Â¹Ëœ
        for (let i = 0; i < 4; i++) {
            if (i < pageImages.length) {
                const imgFile = pageImages[i];
                const imgURL = URL.createObjectURL(imgFile);
                const filename = imgFile.name.replace(/\.png$/i, '');
                
                html += `
                <div class="problem-cell">
                    <div class="answer-check">
                        <button class="check-btn" onclick="markAnswer('${imgFile.name.replace(/'/g,"\\'")}', true)">âœ…</button>
                        <button class="check-btn" onclick="markAnswer('${imgFile.name.replace(/'/g,"\\'")}', false)">âŒ</button>
                    </div>
                    <div class="problem-header">
                        <span class="number">ë¬¸ì œ ${problemNumber}</span>
                        ${showFilename ? `<span class="filename">${filename}</span>` : ''}
                    </div>
                    <div class="image-container">
                        <img src="${imgURL}" class="problem-image" alt="ë¬¸ì œ ${problemNumber}">
                    </div>
                    <div class="solution-area">
                        <div class="solution-label">&lt;í’€ì´&gt;</div>
                    </div>
                </div>
                `;
                problemNumber++;
            } else {
                // ë¹ˆ ì…€
                html += `<div class="problem-cell" style="border:none;"></div>`;
            }
        }

        html += `</div></div>`;
    }

    // í•´ì„¤ ë§¤í•‘ (ë¬¸ì œ ìˆœì„œëŒ€ë¡œ) â€” í•´ì„¤ì€ ë¬¸ì œ ë’¤(ë§ˆì§€ë§‰)ì— ë¶™ìŒ
    // í•´ì„¤ í˜ì´ì§€ ìƒì„± (2x2 ê·¸ë¦¬ë“œ)
    const explanations = selectedImages.map((imgFile, idx) => {
        return { problemNumber: idx + 1, explanationFile: findExplanationFor(imgFile.name) };
    }).filter(item => item.explanationFile);

    if (explanations.length > 0) {
        const explPages = Math.ceil(explanations.length / 4);
        
        for (let p = 0; p < explPages; p++) {
            const explStart = p * 4;
            const pageExpl = explanations.slice(explStart, explStart + 4);
            
            html += `<div class="exam-page"><div class="problem-grid">`;
            
            for (let i = 0; i < 4; i++) {
                if (i < pageExpl.length) {
                    const item = pageExpl[i];
                    const u = URL.createObjectURL(item.explanationFile);
                    html += `
                    <div class="problem-cell">
                        <div class="problem-header">
                            <span class="number">í•´ì„¤ ${item.problemNumber}</span>
                        </div>
                        <div class="image-container" style="max-height:none; flex:1;">
                            <img src="${u}" class="problem-image" style="max-height:none;">
                        </div>
                    </div>
                    `;
                } else {
                    html += `<div class="problem-cell" style="border:none;"></div>`;
                }
            }
            
            html += `</div></div>`;
        }
    }



              

    // ê²°ê³¼ ë°˜ì˜ ë° UI ì—…ë°ì´íŠ¸
    document.getElementById('quizSheet').innerHTML = html;
    updateAnswerButtons();
    showStatus(`âœ… ìƒì„± ì™„ë£Œ: ë¬¸ì œ ${currentQuizImages.length}ê°œ + í•´ì„¤(ê°€ëŠ¥í•œ ê²½ìš°)`, true);
}

        
        // ë°ì´í„° ë‚´ë³´ë‚´ê¸°
        function exportData() {
            if (!currentStudent) {
                showStatus('í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”.', false);
                return;
            }
            
            const data = localStorage.getItem(`student_${currentStudent}`);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentStudent}_í•™ìŠµë°ì´í„°_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showStatus('ë°ì´í„°ë¥¼ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤.', true);
        }
        
        // ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    const name = prompt('ë¶ˆëŸ¬ì˜¬ í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');
                    if (!name) return;
                    
                    localStorage.setItem(`student_${name}`, JSON.stringify(data));
                    const students = JSON.parse(localStorage.getItem('students') || '[]');
                    if (!students.includes(name)) {
                        students.push(name);
                        localStorage.setItem('students', JSON.stringify(students));
                    }
                    
                    loadStudents();
                    showStatus('ë°ì´í„°ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.', true);
                } catch (err) {
                    showStatus('íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', false);
                }
            };
            reader.readAsText(file);
        }
        
        // ì „ì²´ ì´ˆê¸°í™”
        function resetAllData() {
            if (!confirm('ëª¨ë“  í•™ìƒì˜ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            localStorage.clear();
            currentStudent = '';
            allImages = [];
            loadStudents();
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('quizSheet').innerHTML = '';
            showStatus('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', true);
        }
        
        // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        function showStatus(message, isSuccess) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.style.display = 'block';
            status.style.borderLeftColor = isSuccess ? '#4CAF50' : '#f44336';
            status.style.background = isSuccess ? '#e8f5e9' : '#ffebee';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }

// ì¹´ë©”ë¼ ê´€ë ¨ ë³€ìˆ˜
        // IndexedDB ì´ˆê¸°í™”
        let db = null;
        
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('RoutineMathDB', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('photos')) {
                        const store = db.createObjectStore('photos', { keyPath: 'filename' });
                        store.createIndex('student', 'student', { unique: false });
                        store.createIndex('date', 'date', { unique: false });
                    }
                };
            });
        }
        
        // ì¹´ë©”ë¼ ê´€ë ¨ ë³€ìˆ˜
        let cameraStream = null;
        let capturedImageData = null;
        
        // ì¹´ë©”ë¼ ì‹œì‘
        async function startCamera() {
            if (!currentStudent) {
                showStatus('ë¨¼ì € í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”.', false);
                return;
            }
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } // í›„ë©´ ì¹´ë©”ë¼ ìš°ì„ 
                });
                cameraStream = stream;
                document.getElementById('cameraVideo').srcObject = stream;
                document.getElementById('cameraContainer').style.display = 'block';
                document.getElementById('capturedPhotoContainer').style.display = 'none';
            } catch (err) {
                showStatus('ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: ' + err.message, false);
            }
        }
        
        // ì¹´ë©”ë¼ ì •ì§€
        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            document.getElementById('cameraContainer').style.display = 'none';
        }
        
        // ì‚¬ì§„ ì´¬ì˜
        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('photoCanvas');
            const ctx = canvas.getContext('2d');
            
            // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì • (ë¦¬ì‚¬ì´ì¦ˆ)
            const maxSize = 1920;
            let width = video.videoWidth;
            let height = video.videoHeight;
            
            if (width > maxSize || height > maxSize) {
                if (width > height) {
                    height = (height / width) * maxSize;
                    width = maxSize;
                } else {
                    width = (width / height) * maxSize;
                    height = maxSize;
                }
            }
            
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(video, 0, 0, width, height);
            
            // ì´ë¯¸ì§€ ë°ì´í„° ì €ì¥ (ì••ì¶•)
            capturedImageData = canvas.toDataURL('image/jpeg', 0.8);
            
            // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
            document.getElementById('capturedPhoto').src = capturedImageData;
            document.getElementById('cameraContainer').style.display = 'none';
            document.getElementById('capturedPhotoContainer').style.display = 'block';
            
            stopCamera();
            
            // íŒŒì¼ëª… ìë™ ìƒì„±
            const now = new Date();
            const dateStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
            document.getElementById('photoFilename').value = `ë¬¸ì œ_${dateStr}`;
        }
        
        // ê°¤ëŸ¬ë¦¬ì—ì„œ ì„ íƒ
        function handlePhotoSelect(event) {
            if (!currentStudent) {
                showStatus('ë¨¼ì € í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”.', false);
                return;
            }
            
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.getElementById('photoCanvas');
                    const ctx = canvas.getContext('2d');
                    
                    // ë¦¬ì‚¬ì´ì¦ˆ
                    let width = img.width;
                    let height = img.height;
                    const maxSize = 1920;
                    
                    if (width > maxSize || height > maxSize) {
                        if (width > height) {
                            height = (height / width) * maxSize;
                            width = maxSize;
                        } else {
                            width = (width / height) * maxSize;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    capturedImageData = canvas.toDataURL('image/jpeg', 0.8);
                    document.getElementById('capturedPhoto').src = capturedImageData;
                    document.getElementById('capturedPhotoContainer').style.display = 'block';
                    
                    const originalName = file.name.replace(/\.(jpg|jpeg|png)$/i, '');
                    document.getElementById('photoFilename').value = originalName;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // IndexedDBì— ì‚¬ì§„ ì €ì¥
        async function savePhoto() {
            const filename = document.getElementById('photoFilename').value.trim();
            if (!filename) {
                showStatus('íŒŒì¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.', false);
                return;
            }
            
            if (!db) {
                await initDB();
            }
            
            try {
                const transaction = db.transaction(['photos'], 'readwrite');
                const store = transaction.objectStore('photos');
                
                const photoData = {
                    filename: `${filename}.png`,
                    student: currentStudent,
                    imageData: capturedImageData,
                    date: new Date().toISOString()
                };
                
                const request = store.put(photoData);
                
                request.onsuccess = () => {
                    // File ê°ì²´ ìƒì„±í•˜ì—¬ allImagesì— ì¶”ê°€
                    fetch(capturedImageData)
                        .then(res => res.blob())
                        .then(blob => {
                            const file = new File([blob], `${filename}.png`, { type: 'image/png' });
                            allImages.push(file);
                            
                            // í•™ìƒ ë°ì´í„°ì— ì¶”ê°€
                            const key = `student_${currentStudent}`;
                            let data = JSON.parse(localStorage.getItem(key) || '{}');
                            data[file.name] = {
                                level: 'ì·¨ì•½ë¬¸ì œ',
                                correctStreak: 0,
                                totalCorrect: 0,
                                totalWrong: 0,
                                history: [],
                                capturedDate: new Date().toISOString()
                            };
                            localStorage.setItem(key, JSON.stringify(data));
                            
                            showStatus(`âœ… "${filename}.png" IndexedDBì— ì €ì¥ ì™„ë£Œ! (ì´ ${allImages.length}ê°œ)`, true);
                            cancelPhoto();
                            updateDashboard();
                            showProblemList();
                        });
                };
                
                request.onerror = () => {
                    showStatus('ì €ì¥ ì‹¤íŒ¨: ' + request.error, false);
                };
                
            } catch (err) {
                showStatus('ì €ì¥ ì‹¤íŒ¨: ' + err.message, false);
            }
        }
        
        // IndexedDBì—ì„œ ì‚¬ì§„ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadPhotosFromDB() {
            if (!currentStudent) return;
            if (!db) await initDB();
            
            try {
                const transaction = db.transaction(['photos'], 'readonly');
                const store = transaction.objectStore('photos');
                const index = store.index('student');
                const request = index.getAll(currentStudent);
                
                request.onsuccess = () => {
                    const photos = request.result;
                    
                    photos.forEach(photo => {
                        fetch(photo.imageData)
                            .then(res => res.blob())
                            .then(blob => {
                                const file = new File([blob], photo.filename, { type: 'image/png' });
                                // ì¤‘ë³µ ì²´í¬
                                if (!allImages.find(f => f.name === file.name)) {
                                    allImages.push(file);
                                }
                            });
                    });
                    
                    if (photos.length > 0) {
                        setTimeout(() => {
                            showStatus(`ğŸ“¸ ì´¬ì˜í•œ ì‚¬ì§„ ${photos.length}ê°œë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`, true);
                            showProblemList();
                        }, 500);
                    }
                };
                
            } catch (err) {
                console.error('ì‚¬ì§„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', err);
            }
        }
        
        // ì´¬ì˜ ì·¨ì†Œ
        function cancelPhoto() {
            capturedImageData = null;
            document.getElementById('capturedPhotoContainer').style.display = 'none';
            document.getElementById('photoFilename').value = '';
            document.getElementById('photoInput').value = '';
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = init;
    </script>
    
    <script>
        // PWA ì§€ì›
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js')
                .then(() => console.log('PWA ì¤€ë¹„ ì™„ë£Œ!'))
                .catch(() => console.log('PWA ë¯¸ì§€ì›'));
        }
    </script>
</body>
</html>
